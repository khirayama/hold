<!DOCTYPE html>
<html>
  <head>
  <title>Sample</title>
  <meta charset="utf-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
  <script>
window.resources = {};
function createSelectElement(element, json) {
  var $element = $(element);
  var html = '<select name="' + $element.attr('name') + '" data-key="' + $element.data('key') + '">';
  json.forEach(function(item) {
    html += '<option value="' + item.id + '">' + item.name + '</option>';
  });
  html += '</select>';
  $element.html(html);
}
function crud($parent, resources, template, shownUpdateBoxCallback) {
  // init
  $parent.find('.update-box').hide();

  // index
  $.ajax({
    type: 'GET',
    url: `/api/v1/${resources}`
  }).done(function(res) {
    window.resources[resources] = res;
    res.forEach(function (resource) {
      $parent.find('.index-list').append(template(resource));
    });
  });

  // create
  $parent.on('click', '.create-button', function(event) {
    var data = {};
    var $box = $parent.find('.create-box');
    $box.find('input, select').each((index, input) => {
      var $input = $(input);
      data[$input.attr('name')] = $input.val();
    });
    $.ajax({
      type: 'POST',
      url: `/api/v1/${resources}`,
      data: data
    }).done(function(res) {
      location.reload();
    });
  });
  $parent.on('keydown', '.create-box input', function(event) {
    if (event.keyCode === 13) $parent.find('.create-button').trigger('click');
  });

  // edit
  $parent.on('click', '.edit-button', function(event) {
    var data = $(event.target).data('content');
    var $box = $parent.find('.update-box');
    $parent.find('.create-box').hide();
    $box.show();
    shownUpdateBoxCallback();
    $box.find('input').each(function(index, input) {
      var $input = $(input);
      var key = $input.data('key') || $input.attr('name');
      $input.val(data[key]);
    });
  });

  $parent.on('click', '.cancel-edit-button', function() {
    $parent.find('.create-box').show();
    $parent.find('.update-box').hide();
  });

  // update
  $parent.on('click', '.update-button', function(event) {
    var data = {};
    var $box = $parent.find('.update-box');
    var id = $parent.find('input[name="id"]').val();
    $box.find('input, select').each((index, input) => {
      var $input = $(input);
      if ($input.attr('name') != 'id') {
        data[$input.attr('name')] = $input.val();
      }
    });
    $.ajax({
      type: 'PUT',
      url: `/api/v1/${resources}/${id}`,
      data: data
    }).done(function(res) {
      location.reload();
    });
  });
  $parent.on('keydown', '.update-box input', function(event) {
    if (event.keyCode === 13) $parent.find('.update-button').trigger('click');
  });

  // delete
  $parent.on('click', '.delete-button', function(event) {
    var id = $(event.target).data('id');
    $.ajax({
      type: 'DELETE',
      url: `/api/v1/${resources}/${id}`,
    }).done(function(res) {
      location.reload();
    });
  });
}
  </script>
</head>
<body>
  <a href="/api/v1/auth/twitter">Sign up with Twitter</a>

  <h2>User</h2>
  <div class="user-information"></div>
  <script>
$.ajax({
  type: 'GET',
  url: '/api/v1/current_user_information'
}).done(function(res) {
  $('.user-information').html(JSON.stringify(res));
});
  </script>

  <h2>Accounts</h2>
  <div class="accounts">
    <div class="create-box">
      <input type="text" name="name" />
      <input type="number" name="amount" />
      <div class="create-button">Create</div>
    </div>
    <div class="update-box">
      <input type="hidden" name="id" />
      <input type="text" name="name" />
      <input type="number" name="amount" />
      <div class="update-button">Update</div>
      <div class="cancel-edit-button">Cancel</div>
    </div>
    <ul class="index-list"></ul>
  </div>
  <script>
var $accounts = $('.accounts');
function accountTemplate(account) {
  return `
    <li>
    ${account.id} / ${account.name} / ${account.amount}
    <div class="edit-button" data-content='${JSON.stringify(account)}'>Edit</div>
    <div class="delete-button" data-id="${account.id}">Delete</div>
    </li>
  `;
}
crud($accounts, 'accounts', accountTemplate);
  </script>

  <h2>TransactionCategories</h2>
  <div class="transaction-categories">
    <div class="create-box">
      <input type="text" name="name" />
      <div class="create-button">Create</div>
    </div>
    <div class="update-box">
      <input type="hidden" name="id" />
      <input type="text" name="name" />
      <div class="update-button">Update</div>
      <div class="cancel-edit-button">Cancel</div>
    </div>
    <ul class="index-list"></ul>
  </div>
  <script>
var $transactionCategories = $('.transaction-categories');
function transactionCategoryTemplate(transactionCategory) {
  return `
    <li>
      ${transactionCategory.id} / ${transactionCategory.name}
      <div class="edit-button" data-content='${JSON.stringify(transactionCategory)}'>Edit</div>
      <div class="delete-button" data-id="${transactionCategory.id}">Delete</div>
    </li>
  `;
}
crud($transactionCategories, 'transaction_categories', transactionCategoryTemplate);
  </script>

  <h2>Transactions</h2>
  <div class="transactions">
    <div class="create-box">
      from:<div class="js-select-accounts" name="from_account_id"></div>
      to:<div class="js-select-accounts" name="to_account_id"></div>
      transaction category:<div class="js-select-transaction-categories" name="transaction_category_id"></div>
      <input type="number" name="amount" />
      <input type="date" name="payment_date" />
      <input type="date" name="transaction_date" />
      <div class="create-button">Create</div>
    </div>
    <div class="update-box">
      <input type="hidden" name="id" />
      from:<div class="js-select-accounts" name="from_account_id"></div>
      to:<div class="js-select-accounts" name="to_account_id"></div>
      transaction category:<div class="js-select-transaction-categories" name="transaction_category_id"></div>
      <input type="number" name="amount" />
      <input type="date" name="payment_date"/>
      <input type="date" name="transaction_date" />
      <div class="update-button">Update</div>
      <div class="cancel-edit-button">Cancel</div>
    </div>
    <ul class="index-list"></ul>
  </div>
  <script>
var $transactions = $('.transactions');
function transactionTemplate(transaction) {
  return `
    <li>
      ${transaction.id} /
      ${(transaction.from_account) ? transaction.from_account.name : ' - '} /
      ${(transaction.to_account) ? transaction.to_account.name : ' - '} /
      ${transaction.amount} /
      ${(transaction.transaction_category) ? transaction.transaction_category.name : ' - '} /
      ${transaction.payment_date} / ${transaction.transaction_date}
      <div class="edit-button" data-content='${JSON.stringify(transaction)}'>Edit</div>
      <div class="delete-button" data-id="${transaction.id}">Delete</div>
    </li>
  `;
}
function createUpdateTransactionForm() {
  document.querySelectorAll('.js-select-accounts').forEach(function(element) {
    createSelectElement(element, [{name: 'none', id: null}].concat(window.resources.accounts));
  });
  document.querySelectorAll('.js-select-transaction-categories').forEach(function(element) {
    createSelectElement(element, [{name: 'none', id: null}].concat(window.resources.transaction_categories));
  });
}
setTimeout(function() {
  createUpdateTransactionForm();
}, 1000);
crud($transactions, 'transactions', transactionTemplate, createUpdateTransactionForm);
  </script>
</body>
</html>
